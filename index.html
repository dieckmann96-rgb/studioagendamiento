<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulce de Leche Studio - Agendamento</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define a fonte e alguns estilos base -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root {
            --color-primary: #8B4513; /* Marrom escuro (terracota/sépia) */
            --color-secondary: #FFDAB9; /* Pêssego (claro, background) */
            --color-accent: #DAA520; /* Dourado (botões) */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-secondary);
            min-height: 100vh;
        }
        /* Estilos personalizados para o botão de confirmação */
        .btn-confirm {
            background-color: var(--color-accent);
            color: var(--color-primary);
            transition: background-color 0.3s;
        }
        .btn-confirm:hover {
            background-color: #C5931D;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center">

    <!-- Cabeçalho Principal -->
    <header class="w-full max-w-lg mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-primary mb-2" style="color:var(--color-primary);">Dulce de Leche Studio</h1>
        <div id="nav-container" class="flex justify-center space-x-4">
            <button id="btn-agendar" class="text-lg font-semibold text-gray-800 hover:text-gray-900 border-b-2 border-transparent">Agendar</button>
            <button id="btn-admin" class="text-lg font-semibold text-gray-800 hover:text-gray-900 border-b-2 border-transparent">Admin</button>
        </div>
    </header>

    <!-- Container Principal do Conteúdo -->
    <main id="app-container" class="w-full max-w-lg bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-8 border-r-4 border-accent" style="border-color:var(--color-accent);">
        
        <!-- Área de Mensagens de Erro/Sucesso (Inicialmente oculta) -->
        <div id="message-area" class="mb-4 hidden p-3 rounded-lg text-center font-medium"></div>

        <!-- Conteúdo dinâmico será injetado aqui -->
        <div id="content-container">
            <!-- Conteúdo de agendamento padrão -->
        </div>
        
    </main>

    <!-- MODAL (Usado para Confirmação e Mensagens) -->
    <div id="app-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 justify-center items-center p-4">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-center text-primary" style="color:var(--color-primary);"></h2>
            <p id="modal-content" class="mb-6 text-gray-700 text-center"></p>
            <div id="modal-actions" class="flex justify-center space-x-4">
                <button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Configuração e Lógica JavaScript -->
    <script type="module">
        // #############################################################################################
        // 1. VARIÁVEIS DO AMBIENTE (PLACEHOLDERS)
        // O script 'replace_vars.js' DEVE substituir estas strings durante o deploy do Vercel.
        // #############################################################################################

        // Placeholders. O valor real do Firebase Config (em Base64) será injetado aqui.
        const firebaseConfigBase64 = '__FIREBASE_CONFIG__';
        // O valor da senha de administrador será injetado aqui.
        const adminSecret = '__ADMIN_SECRET__';

        let firebaseConfig, db, auth, userId, appId;

        // Decodifica a string Base64 para JSON
        function decodeBase64(base64) {
            try {
                // atob decodifica Base64 em ambientes de navegador.
                const jsonString = atob(base64);
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Erro ao decodificar ou parsear Base64:", e);
                return null;
            }
        }

        // Tenta carregar e decodificar a configuração
        try {
            // Verifica se a substituição realmente ocorreu (o comprimento > 20 garante que não é apenas "CONFIG_ERROR")
            if (firebaseConfigBase64 && firebaseConfigBase64.length > 20 && firebaseConfigBase64 !== '__FIREBASE_CONFIG__') {
                firebaseConfig = decodeBase64(firebaseConfigBase64);
            }
            
            if (!firebaseConfig || firebaseConfigBase64 === '__FIREBASE_CONFIG__' || firebaseConfigBase64 === '__CONFIG_ERROR__') {
                throw new Error("Configuração não injetada ou inválida. Placeholder não substituído.");
            }
            
        } catch (error) {
            console.error("Erro ao carregar FIREBASE_CONFIG:", error);
            document.getElementById('content-container').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Erro de Configuração! (CÓDIGO 1)</strong>
                    <span class="block sm:inline">O aplicativo não conseguiu carregar as configurações do Firebase. Isso indica que a variável de ambiente não foi injetada pelo Vercel. Por favor, verifique o log do comando **npm run build** para erros.</span>
                </div>
            `;
            // Aborta a execução do script se a configuração for inválida.
            throw new Error("Configuração Firebase inválida. Verifique o Vercel.");
        }
        
        // Esta função é chamada apenas se a configuração do Firebase for válida.
        async function setupApp() {
            // #############################################################################################
            // 2. IMPORTS E INICIALIZAÇÃO DO FIREBASE
            // #############################################################################################
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, addDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            // #############################################################################################
            // 3. INICIALIZAÇÃO DE SERVIÇOS
            // #############################################################################################

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // O ID da Aplicação é o projectId do Firebase, usado no caminho do Firestore.
            appId = firebaseConfig.projectId;
            
            // Define o caminho base para a coleção pública de agendamentos
            const getAppointmentsCollectionPath = (uid) => `artifacts/${appId}/public/data/appointments`;
            
            // #############################################################################################
            // 4. FUNÇÕES DE UTILIDADE E UI
            // #############################################################################################

            // Função para mostrar o modal
            function showModal(title, content, actionsHtml = '', canClose = true) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-content').innerHTML = content;
                const actionsContainer = document.getElementById('modal-actions');
                actionsContainer.innerHTML = actionsHtml;
                
                if (canClose) {
                    const closeButton = document.createElement('button');
                    closeButton.id = 'modal-close-custom';
                    closeButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition';
                    closeButton.textContent = 'Fechar';
                    closeButton.onclick = () => document.getElementById('app-modal').classList.add('hidden');
                    actionsContainer.appendChild(closeButton);
                }
                
                document.getElementById('app-modal').classList.remove('hidden');
            }

            // Função para formatar a data (dd/mm/aaaa)
            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
            };
            
            // Função para formatar a hora (HH:mm)
            const formatTime = (time) => time.split('T')[1].substring(0, 5);

            // Função para carregar o template de Agendamento
            function renderAgendar() {
                document.getElementById('content-container').innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6 text-center text-primary" style="color:var(--color-primary);">Agendar Horário</h2>
                    
                    <form id="appointment-form" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Nome completo</label>
                            <input type="text" id="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-accent focus:border-accent border">
                        </div>
                        <div>
                            <label for="whatsapp" class="block text-sm font-medium text-gray-700">Telefone (WhatsApp)</label>
                            <input type="tel" id="whatsapp" required placeholder="Ex: 595981234567" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-accent focus:border-accent border">
                        </div>
                        <div>
                            <label for="service" class="block text-sm font-medium text-gray-700">Serviço</label>
                            <select id="service" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-accent focus:border-accent border">
                                <option value="">Selecione um serviço</option>
                                <option value="Maquiagem Social">Maquiagem Social</option>
                                <option value="Maquiagem Noiva">Maquiagem Noiva</option>
                                <option value="Curso de Automaquiagem">Curso de Automaquiagem</option>
                                <option value="Extensão de Cílios">Extensão de Cílios</option>
                            </select>
                        </div>
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Data e Hora</label>
                            <input type="datetime-local" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-accent focus:border-accent border">
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Observações (Opcional)</label>
                            <textarea id="notes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-accent focus:border-accent border" placeholder="Detalhes de preferência de profissional, alergias, etc."></textarea>
                        </div>
                        <button type="submit" class="w-full btn-confirm py-3 rounded-xl font-bold text-lg shadow-lg">
                            Confirmar Agendamento e Abrir WhatsApp
                        </button>
                    </form>
                `;
                
                // Adiciona o listener de submissão do formulário
                document.getElementById('appointment-form').addEventListener('submit', handleNewAppointment);
                
                // Atualiza o estado de navegação
                document.getElementById('btn-agendar').classList.add('border-primary');
                document.getElementById('btn-admin').classList.remove('border-primary');
            }

            // Função para carregar o template de Administração
            function renderAdmin(isLoggedIn = false) {
                document.getElementById('content-container').innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6 text-center text-primary" style="color:var(--color-primary);">Acesso Administrativo</h2>
                    <div id="admin-panel" class="space-y-4">
                        ${isLoggedIn ? `
                            <p class="text-green-600 font-semibold text-center">Admin logado com sucesso!</p>
                            <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                                <span class="text-sm font-medium">Seu ID de Usuário (Admin):</span>
                                <span class="text-xs break-all">${auth.currentUser?.uid || 'N/A'}</span>
                            </div>
                            <button id="logout-btn" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition shadow-lg">Sair (Logout)</button>
                            <h3 class="text-xl font-semibold mt-6 mb-4 text-primary" style="color:var(--color-primary);">Agendamentos Pendentes</h3>
                            <div id="appointments-list" class="space-y-3">
                                <p class="text-gray-500 text-center">Carregando agendamentos...</p>
                            </div>
                        ` : `
                            <form id="login-form" class="space-y-4">
                                <div>
                                    <label for="admin-secret" class="block text-sm font-medium text-gray-700">Senha de Administrador</label>
                                    <input type="password" id="admin-secret" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-accent focus:border-accent border">
                                </div>
                                <div id="login-error" class="text-red-500 font-medium hidden">Senha de administrador incorreta.</div>
                                <button type="submit" class="w-full bg-primary text-white py-3 rounded-xl font-bold text-lg hover:bg-secondary-dark transition shadow-lg" style="background-color:var(--color-primary);">
                                    Login
                                </button>
                            </form>
                        `}
                    </div>
                `;

                if (isLoggedIn) {
                    // Configura o listener em tempo real para os agendamentos
                    setupAppointmentListener();
                    document.getElementById('logout-btn').addEventListener('click', () => {
                        renderAdmin(false); // Simplesmente reverte para a tela de login
                        // No mundo real, aqui você deslogaria um usuário com e-mail/senha
                    });
                } else {
                    document.getElementById('login-form')?.addEventListener('submit', handleLogin);
                }
                
                // Atualiza o estado de navegação
                document.getElementById('btn-agendar').classList.remove('border-primary');
                document.getElementById('btn-admin').classList.add('border-primary');
            }
            
            // #############################################################################################
            // 5. LÓGICA DE AGENDAMENTO (USUÁRIO FINAL)
            // #############################################################################################

            async function handleNewAppointment(e) {
                e.preventDefault();
                
                // 1. Coleta e validação de dados
                const name = document.getElementById('name').value.trim();
                const whatsapp = document.getElementById('whatsapp').value.trim();
                const service = document.getElementById('service').value;
                const dateInput = document.getElementById('date').value;
                const notes = document.getElementById('notes').value.trim();
                
                if (!name || !whatsapp || !service || !dateInput) {
                    showModal('Erro de Validação', 'Por favor, preencha todos os campos obrigatórios.');
                    return;
                }
                
                const appointmentTime = new Date(dateInput);
                if (isNaN(appointmentTime)) {
                    showModal('Erro de Data', 'Formato de data e hora inválido.');
                    return;
                }
                
                // 2. Criação do objeto de agendamento
                const newAppointment = {
                    name,
                    whatsapp,
                    service,
                    dateTime: appointmentTime,
                    notes: notes || 'Nenhuma observação.',
                    status: 'Pendente',
                    createdAt: new Date(),
                    // Guarda o ID do usuário anônimo (quem agendou)
                    userId: auth.currentUser?.uid || 'anonimo-nao-autenticado', 
                };

                try {
                    // 3. Salva no Firestore
                    // Usa a coleção pública para agendamentos compartilhados
                    const colRef = collection(db, getAppointmentsCollectionPath());
                    await addDoc(colRef, newAppointment);
                    
                    // 4. Constrói a mensagem do WhatsApp
                    const whatsappMessage = `Olá! Acabei de agendar um horário no Dulce de Leche Studio.

*Detalhes do Agendamento:*
*Nome:* ${name}
*Serviço:* ${service}
*Data:* ${formatDate(appointmentTime)}
*Hora:* ${formatTime(dateInput)}
*Observações:* ${newAppointment.notes}

Por favor, confirme a disponibilidade!`;

                    const whatsappUrl = `https://wa.me/${whatsapp}?text=${encodeURIComponent(whatsappMessage)}`;
                    
                    // 5. Exibe o modal de sucesso com link do WhatsApp
                    showModal(
                        'Agendamento Confirmado!',
                        `<p>Seu horário para **${service}** no dia **${formatDate(appointmentTime)}** foi reservado como *Pendente*. </p><p class="mt-2 text-sm">Clique abaixo para nos enviar os detalhes por WhatsApp para confirmação final.</p>`,
                        `<a href="${whatsappUrl}" target="_blank" class="w-full btn-confirm py-3 px-4 rounded-xl font-bold text-lg inline-block text-center shadow-lg hover:brightness-110">
                            Abrir WhatsApp
                        </a>`
                    );

                    document.getElementById('appointment-form').reset();
                } catch (error) {
                    console.error("Erro ao salvar agendamento:", error);
                    showModal('Erro no Agendamento', `Não foi possível salvar seu agendamento. Detalhes: ${error.message}. Por favor, verifique as Regras de Segurança do Firestore.`);
                }
            }
            
            // #############################################################################################
            // 6. LÓGICA DE ADMINISTRAÇÃO (PAINEL ADMIN)
            // #############################################################################################

            function handleLogin(e) {
                e.preventDefault();
                const secret = document.getElementById('admin-secret').value.trim();
                const loginError = document.getElementById('login-error');

                // A senha do admin é comparada com a variável injetada
                if (secret === adminSecret) {
                    loginError.classList.add('hidden');
                    renderAdmin(true); // Login Simulado (baseado apenas na chave secreta)
                } else {
                    loginError.classList.remove('hidden');
                }
            }

            // Renderiza a lista de agendamentos
            function updateAppointmentsList(appointments) {
                const listContainer = document.getElementById('appointments-list');
                if (!listContainer) return;
                
                if (appointments.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-50 rounded-lg">Nenhum agendamento pendente encontrado.</p>';
                    return;
                }
                
                listContainer.innerHTML = appointments.map(app => `
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-accent" style="border-color:var(--color-accent);">
                        <p class="font-bold text-primary" style="color:var(--color-primary);">${formatDate(app.dateTime.toDate())} às ${formatTime(app.dateTime.toDate().toISOString())}</p>
                        <p class="text-sm">Cliente: ${app.name}</p>
                        <p class="text-sm">Serviço: <span class="font-semibold">${app.service}</span></p>
                        <p class="text-sm">WhatsApp: ${app.whatsapp}</p>
                        <p class="text-xs mt-2 text-gray-500">Notas: ${app.notes}</p>
                        <span class="inline-block mt-3 px-3 py-1 text-xs font-semibold rounded-full ${app.status === 'Confirmado' ? 'bg-green-100 text-green-800' : app.status === 'Cancelado' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${app.status}</span>
                        <div class="mt-3 flex space-x-2">
                            <button data-id="${app.id}" data-status="Confirmado" class="update-status-btn px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">Confirmar</button>
                            <button data-id="${app.id}" data-status="Cancelado" class="update-status-btn px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">Cancelar</button>
                        </div>
                    </div>
                `).join('');

                // Adiciona listeners para os botões de status
                document.querySelectorAll('.update-status-btn').forEach(button => {
                    button.addEventListener('click', handleStatusUpdate);
                });
            }
            
            // Listener em tempo real para a lista de agendamentos no Admin
            function setupAppointmentListener() {
                const q = query(collection(db, getAppointmentsCollectionPath()));
                
                onSnapshot(q, (snapshot) => {
                    const appointments = [];
                    snapshot.forEach((doc) => {
                        appointments.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordena por data (o mais antigo primeiro)
                    appointments.sort((a, b) => a.dateTime.toDate() - b.dateTime.toDate());
                    
                    updateAppointmentsList(appointments);
                }, (error) => {
                    console.error("Erro ao ouvir agendamentos em tempo real:", error);
                    document.getElementById('appointments-list').innerHTML = `<p class="text-red-500 text-center p-4">Erro ao carregar dados: ${error.message}</p>`;
                });
            }

            // Função para atualizar o status de um agendamento
            async function handleStatusUpdate(e) {
                const id = e.target.dataset.id;
                const newStatus = e.target.dataset.status;
                
                if (!id || !newStatus) return;
                
                try {
                    const appointmentRef = doc(db, getAppointmentsCollectionPath(), id);
                    await setDoc(appointmentRef, { status: newStatus }, { merge: true });
                    // O onSnapshot acima irá atualizar a lista automaticamente.
                    showModal('Status Atualizado', `Agendamento ${id.substring(0, 4)}... foi marcado como **${newStatus}**.`);
                } catch (error) {
                    console.error("Erro ao atualizar status:", error);
                    showModal('Erro de Atualização', `Não foi possível mudar o status para ${newStatus}. Detalhes: ${error.message}`);
                }
            }


            // #############################################################################################
            // 7. INICIALIZAÇÃO DA APLICAÇÃO (FLOW PRINCIPAL)
            // #############################################################################################

            // 7.1. Tratamento de Autenticação (CRÍTICO para Firestore)
            await new Promise(resolve => {
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            // Tenta logar anonimamente
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Falha ao autenticar anonimamente:", error);
                            showModal('Erro de Autenticação', 'Não foi possível autenticar o usuário anônimo. Por favor, verifique a ativação do método de login "Anônimo" no Firebase Authentication.');
                        }
                    }
                    userId = auth.currentUser?.uid;
                    resolve();
                });
            });

            // 7.2. Configuração de Navegação e Estado
            const btnAgendar = document.getElementById('btn-agendar');
            const btnAdmin = document.getElementById('btn-admin');
            
            // Listener para alternar para Agendar
            btnAgendar.addEventListener('click', renderAgendar);
            
            // Listener para alternar para Admin
            btnAdmin.addEventListener('click', () => renderAdmin(false)); // Sempre começa na tela de login
            
            // Inicia na tela de Agendamento
            renderAgendar();

            console.log("Aplicativo Dulce de Leche Studio inicializado com sucesso.");
            console.log("Usuário autenticado (anônimo) com ID:", userId);
        }
        
        // Chamada da função de inicialização APENAS se a config do Firebase for válida
        if (firebaseConfigBase64 !== '__FIREBASE_CONFIG__' && firebaseConfig) {
            setupApp();
        }
    </script>
</body>
</html>

