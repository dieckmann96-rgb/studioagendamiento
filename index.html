<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulce de Leche Studio - Agendamento e Administração</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .bg-studio { background-color: #F8F4E3; }
        .text-brown-custom { color: #8B4513; }
        .btn-custom { background-color: #D2B48C; color: #5C4033; transition: all 0.2s; }
        .btn-custom:hover { background-color: #A0522D; color: #FFFFFF; }
        /* Custom scrollbar for Admin Panel */
        .overflow-y-scroll::-webkit-scrollbar { width: 8px; }
        .overflow-y-scroll::-webkit-scrollbar-thumb { background: #D2B48C; border-radius: 4px; }
        .overflow-y-scroll::-webkit-scrollbar-track { background: #F8F4E3; }
    </style>
</head>
<body class="bg-studio min-h-screen">

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for troubleshooting
        setLogLevel('Debug');

        // Global Firebase variables (will be populated on init)
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Constants from Vercel Environment Variables (these are replaced during build)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase and Authentication
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("ERRO FATAL: A configuração do Firebase não foi carregada corretamente.");
                    document.getElementById('app-container').innerHTML = `
                        <div class="max-w-md mx-auto p-6 bg-red-100 text-red-700 rounded-lg shadow-lg mt-20">
                            <p class="font-bold">Erro de Configuração!</p>
                            <p>O aplicativo não conseguiu carregar as configurações do Firebase. Por favor, verifique se as 7 variáveis de ambiente do Vercel estão corretas.</p>
                        </div>
                    `;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication using custom token (preferred) or anonymously (fallback)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Get current user ID
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;

                // --- Ponto de Início Corrigido ---
                // Depois de autenticado, renderiza a UI e inicia o listener de dados.
                renderUI();
                subscribeToAppointments(); 

            } catch (error) {
                console.error("Erro ao inicializar o Firebase ou autenticar:", error);
                document.getElementById('app-container').innerHTML = `
                    <div class="max-w-md mx-auto p-6 bg-red-100 text-red-700 rounded-lg shadow-lg mt-20">
                        <p class="font-bold">Erro de Autenticação/Inicialização!</p>
                        <p>Detalhes: ${error.message}</p>
                    </div>
                `;
            }
        };

        // --- GLOBAL APP STATE AND LOGIC ---
        let currentView = 'schedule'; // 'schedule' or 'admin'
        let adminLoggedIn = false;
        let appointments = [];
        let totalRevenue = 0;

        // Note: This must be replaced by the Vercel build process with the actual secret.
        const ADMIN_SECRET_KEY = "__ADMIN_SECRET_KEY__";

        // Services and Prices in PYG (Guarani)
        const services = [
            // Valores ajustados para Guarani (Gs 150.000, Gs 120.000, Gs 100.000)
            { id: 'extensao', name: 'Extensão de Cílios', price: 150000 },
            { id: 'limpeza', name: 'Limpeza de Pele', price: 120000 },
            { id: 'massagem', name: 'Massagem Relaxante', price: 100000 },
        ];

        // Utility to find price
        const getServicePrice = (serviceId) => {
            const service = services.find(s => s.id === serviceId);
            return service ? service.price : 0;
        };

        // Utility to format currency to Paraguayan Guarani (Gs)
        const formatCurrency = (value) => {
            // Usa o local 'es-PY' para separador de milhar com ponto (Gs 150.000) e sem decimais.
            return 'Gs ' + value.toLocaleString('es-PY', { minimumFractionDigits: 0 });
        };


        // --- FIREBASE INTERACTION ---

        // Function to get the public collection path for appointments
        const getAppointmentsCollectionRef = () => {
            return collection(db, `artifacts/${appId}/public/data/appointments`);
        };

        // Real-time listener for appointments
        const subscribeToAppointments = () => {
            // Garante que o DB está pronto antes de tentar conectar
            if (!isAuthReady || !db) return;

            const appointmentsRef = getAppointmentsCollectionRef();
            const q = query(appointmentsRef);

            onSnapshot(q, (snapshot) => {
                appointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure date is a string or Date object for sorting
                    // Convert Firestore Timestamp to JS Date object
                    date: doc.data().date ? doc.data().date.toDate().toISOString().split('T')[0] : 'N/A'
                }));
                // Sort by date (oldest first) and then timestamp
                appointments.sort((a, b) => {
                    if (a.date < b.date) return -1;
                    if (a.date > b.date) return 1;
                    return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
                });

                // Calculate total revenue
                totalRevenue = appointments.reduce((sum, appt) => sum + getServicePrice(appt.serviceId), 0);

                // Re-render UI based on the current view
                renderUI();
                if (currentView === 'admin') renderAdminPanel();
            }, (error) => {
                console.error("Erro ao receber dados de agendamentos:", error);
            });
        };

        // Function to handle appointment submission
        window.submitAppointment = async () => {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const serviceId = document.getElementById('service').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const observations = document.getElementById('observations').value;

            if (!name || !phone || !serviceId || !date || !time) {
                showMessage("Por favor, preencha todos os campos obrigatórios.", 'error');
                return;
            }

            try {
                // Combine date and time to create a Date object for Firestore
                const appointmentDateTime = new Date(`${date}T${time}:00`);

                // Prevent early appointment dates (optional)
                if (appointmentDateTime < new Date()) {
                    showMessage("A data/hora do agendamento não pode ser no passado.", 'error');
                    return;
                }

                const appointmentData = {
                    name,
                    phone,
                    serviceId,
                    date: appointmentDateTime, // Save as Firestore Timestamp
                    time,
                    observations,
                    serviceName: services.find(s => s.id === serviceId)?.name || 'Desconhecido',
                    price: getServicePrice(serviceId),
                    status: 'Pending', // New field for admin tracking
                    timestamp: serverTimestamp(),
                };

                await addDoc(getAppointmentsCollectionRef(), appointmentData);

                showMessage("Agendamento confirmado! Entraremos em contato para finalizar os detalhes.", 'success');
                // Clear form after success
                document.getElementById('schedule-form').reset();

                // Generate WhatsApp link (optional for user convenience)
                const whatsappMessage = encodeURIComponent(`Olá, ${name}! Confirmei meu agendamento para ${appointmentData.serviceName} em ${date} às ${time}. Observações: ${observations || 'Nenhuma'}.`);
                const whatsappLink = `https://wa.me/595999999999?text=${whatsappMessage}`; // Substitua pelo seu número (595 é o código do Paraguai)
                window.open(whatsappLink, '_blank');

            } catch (error) {
                console.error("Erro ao adicionar agendamento:", error);
                showMessage("Erro ao processar agendamento. Tente novamente.", 'error');
            }
        };

        // --- UI Rendering and Navigation ---

        const showMessage = (message, type = 'info') => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `p-4 mt-4 rounded-lg text-white font-semibold shadow-md ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 5000);
        };

        // Function to switch views
        window.setView = (view) => {
            currentView = view;
            renderUI();
        };

        // Main UI Renderer
        const renderUI = () => {
            const container = document.getElementById('app-container');
            if (currentView === 'schedule') {
                container.innerHTML = renderScheduler();
                populateServiceOptions();
            } else if (currentView === 'admin') {
                if (!adminLoggedIn) {
                    container.innerHTML = renderAdminLogin();
                } else {
                    container.innerHTML = renderAdminPanel();
                }
            }
        };

        // Populate service options in the form
        const populateServiceOptions = () => {
            const serviceSelect = document.getElementById('service');
            if (serviceSelect) {
                serviceSelect.innerHTML = `<option value="" disabled selected>Selecione um Serviço</option>`;
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.name} (${formatCurrency(service.price)})`; // Usando Gs
                    serviceSelect.appendChild(option);
                });
            }
        };

        // --- VIEW RENDERERS ---

        const renderScheduler = () => `
            <div class="max-w-md mx-auto p-6 bg-white rounded-xl shadow-2xl mt-10 border border-brown-custom/30">
                <h2 class="text-3xl font-bold text-center text-brown-custom mb-6 border-b pb-2">Agendar Horário</h2>
                <form id="schedule-form" onsubmit="event.preventDefault(); submitAppointment();">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700">Telefone (WhatsApp)</label>
                        <input type="tel" id="phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="Ex: 999 999999">
                    </div>
                    <div class="mb-4">
                        <label for="service" class="block text-sm font-medium text-gray-700">Serviço</label>
                        <select id="service" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="date" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                    </div>
                    <div class="mb-6">
                        <label for="time" class="block text-sm font-medium text-gray-700">Horário</label>
                        <input type="time" id="time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                    </div>
                    <div class="mb-6">
                        <label for="observations" class="block text-sm font-medium text-gray-700">Observações (Opcional)</label>
                        <textarea id="observations" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500"></textarea>
                    </div>

                    <div id="message-box" style="display:none;" class="mb-4"></div>

                    <button type="submit" class="w-full btn-custom py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transform hover:scale-105">
                        Confirmar Agendamento e Abrir WhatsApp
                    </button>
                </form>
            </div>
        `;

        window.adminLogin = () => {
            const password = document.getElementById('admin-password').value;
            // The actual secret key is stored in the ADMIN_SECRET_KEY environment variable.
            const environmentSecret = ADMIN_SECRET_KEY; 

            if (password === environmentSecret) {
                adminLoggedIn = true;
                renderUI();
                // A subscrição é feita na inicialização, mas garantimos o re-render
                // se o painel admin for a tela atual.
                subscribeToAppointments(); 
            } else {
                showMessage("Senha de administrador incorreta.", 'error');
            }
        };

        const renderAdminLogin = () => `
            <div class="max-w-sm mx-auto p-6 bg-white rounded-xl shadow-2xl mt-20 border border-brown-custom/30">
                <h2 class="text-2xl font-bold text-center text-brown-custom mb-6">Acesso Administrativo</h2>
                <input type="password" id="admin-password" placeholder="Digite a Chave Secreta" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                <div id="message-box" style="display:none;" class="mt-4"></div>
                <button onclick="adminLogin()" class="w-full btn-custom py-2 mt-4 rounded-lg font-bold shadow-lg hover:shadow-xl transform hover:scale-105">
                    Login
                </button>
            </div>
        `;

        window.adminLogout = () => {
            adminLoggedIn = false;
            appointments = [];
            totalRevenue = 0;
            renderUI();
            showMessage("Sessão encerrada.", 'info');
        };

        const renderAdminPanel = () => {
            const formattedRevenue = formatCurrency(totalRevenue); // Usando Gs
            const totalAppointments = appointments.length;

            return `
                <div class="p-4 md:p-8 max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-brown-custom">Painel de Administração</h2>
                        <button onclick="adminLogout()" class="btn-custom py-1 px-4 rounded-lg font-bold shadow-md hover:bg-red-700 hover:text-white">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>

                    <!-- Revenue and Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-green-600">
                            <p class="text-sm font-semibold text-gray-500 uppercase">Faturamento Total (Gs)</p>
                            <p class="text-4xl font-extrabold text-green-700 mt-1">${formattedRevenue}</p>
                            <p class="text-xs text-gray-400 mt-2">Soma dos preços de todos os agendamentos registrados.</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-amber-600">
                            <p class="text-sm font-semibold text-gray-500 uppercase">Total de Agendamentos</p>
                            <p class="text-4xl font-extrabold text-amber-700 mt-1">${totalAppointments}</p>
                            <p class="text-xs text-gray-400 mt-2">Agendamentos pendentes, confirmados e concluídos.</p>
                        </div>
                    </div>
                    
                    <div id="message-box" style="display:none;" class="mb-4"></div>

                    <!-- Appointments List -->
                    <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-brown-custom/30">
                        <div class="p-4 bg-brown-custom text-white font-bold text-lg">Agendamentos Recentes</div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serviço</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (Gs)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${appointments.length > 0 ? appointments.map(appt => `
                                        <tr class="hover:bg-amber-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">
                                                ${new Date(appt.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}<br>
                                                <span class="text-xs text-gray-500">${appt.time}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                ${appt.name}<br>
                                                <a href="https://wa.me/595${appt.phone.replace(/\D/g, '')}" target="_blank" class="text-green-600 hover:text-green-800 text-xs flex items-center">
                                                    <i class="fab fa-whatsapp mr-1"></i> ${appt.phone}
                                                </a>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${appt.serviceName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">${formatCurrency(appt.price)}</td>
                                            <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 max-w-xs">${appt.observations || 'N/A'}</td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="5" class="px-6 py-10 text-center text-gray-500">Nenhum agendamento encontrado no Firebase.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- INITIALIZATION ---
        // Espera a janela carregar e chama o initFirebase.
        window.onload = () => {
            initFirebase();
            // A chamada para subscribeToAppointments e renderUI agora está DENTRO de initFirebase para garantir a ordem correta.
        };
    </script>

    <!-- Navigation Menu (Header) -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-extrabold text-brown-custom">Dulce de Leche Studio</h1>
            <nav class="flex space-x-4">
                <button onclick="setView('schedule')" class="text-brown-custom hover:text-amber-700 font-medium py-1 px-3 rounded-md transition duration-150">
                    <i class="far fa-calendar-alt mr-1"></i> Agendar
                </button>
                <button onclick="setView('admin')" class="text-brown-custom hover:text-amber-700 font-medium py-1 px-3 rounded-md transition duration-150">
                    <i class="fas fa-chart-line mr-1"></i> Admin
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Application Container -->
    <main id="app-container" class="pb-10">
        <!-- Content will be injected here by JavaScript -->
        <div class="max-w-md mx-auto p-6 text-center mt-20 text-brown-custom">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p>Carregando aplicação...</p>
        </div>
    </main>
</body>
</html>

